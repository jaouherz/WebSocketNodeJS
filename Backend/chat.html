<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chatbot | Becodewala</title>
  <link rel="stylesheet" href="/style.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body>
<div class="container">
  <div class="title">Let's Chat</div>
  <div class="chat" id="chat"></div>
  <input type="text" class="input" id="input" placeholder="Type your message here..." />
  <button class="button" id="button"><i class="fa-brands fa-telegram"></i></button>
</div>

<script>
  const urlParams = new URLSearchParams(window.location.search);
  const id = urlParams.get("id");
  const name = urlParams.get("name");

  let ws;

  if (!id || !name) {
    document.body.innerHTML = "<p style='color: red;'>Erreur : Informations d'utilisateur manquantes.</p>";
  } else {
    ws = new WebSocket(`ws://localhost:3000?id=${id}&name=${encodeURIComponent(name)}`);

    ws.onopen = () => {
      console.log("WebSocket connecté !");
      ws.send(`${name} a rejoint le chat.`);
    };

    ws.onmessage = (event) => {
      displayMessage(event.data, "bot");
    };

    ws.onerror = (error) => {
      console.error("WebSocket error:", error);
    };
  }

  function sendMessage() {
    const messageInput = document.getElementById("input");
    const message = messageInput.value.trim();

    if (message !== "" && ws && ws.readyState === WebSocket.OPEN) {
      ws.send(message);
      displayMessage(message, "user");
      messageInput.value = "";
    } else {
      console.log("Impossible d'envoyer un message vide ou WebSocket non connecté.");
    }
  }

  function displayMessage(message, sender) {
    const chat = document.getElementById("chat");
    const msgDiv = document.createElement("div");
    msgDiv.classList.add("message", sender);

    const avatar = document.createElement("div");
    avatar.classList.add("avatar");

    const text = document.createElement("div");
    text.classList.add("text");
    text.textContent = message;

    msgDiv.appendChild(avatar);
    msgDiv.appendChild(text);
    chat.appendChild(msgDiv);

    chat.scrollTop = chat.scrollHeight;
  }

  // Event Listeners
  document.getElementById("button").addEventListener("click", sendMessage);
  document.getElementById("input").addEventListener("keypress", function(event) {
    if (event.key === "Enter") {
      sendMessage();
    }
  });
</script>
</body>
</html>
